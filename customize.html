<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Customize Avatar - Alters.ai</title>
    <link rel="stylesheet" href="/enhanced-styles.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Mulish:wght@300;400;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
      integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <script src="/navbar.js" defer></script>
  </head>
  <body class="hero-bg">
    <!-- Navigation Bar -->
    <nav class="main-nav">
      <div class="nav-container">
        <div class="nav-logo">
          <a href="/" class="logo-text"
            >alters<span class="accent-text">.</span
            ><span class="accent-text small-text">ai</span></a
          >
        </div>
        <div class="nav-links">
          <a href="/creator-studio" class="nav-link">Home</a>
          <a href="/marketplace" class="nav-link">Marketplace</a>
          <a href="/chat" class="nav-link">Chat</a>
        </div>
      </div>
    </nav>

    <main>
      <div id="content">
        <h1 class="title">Customize Your Avatar</h1>
        <p class="subtitle">
          Use our tools to create your perfect digital twin.
        </p>
        <div id="content">
          <div class="nav-bar">
            <button id="back-button" class="nav-button">
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M15 19L8 12L15 5"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
              Back
            </button>
            <button id="next-button" class="nav-button">
              Next
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M9 5L16 12L9 19"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </button>
          </div>
          <div class="timeline">
            <div class="timeline-step active" data-step="1">
              <span class="step-number">1</span>
              <span class="step-label">Basics</span>
            </div>
            <div class="timeline-step" data-step="2">
              <span class="step-number">2</span>
              <span class="step-label">Personality</span>
            </div>
            <div class="timeline-step" data-step="3">
              <span class="step-number">3</span>
              <span class="step-label">Knowledge</span>
            </div>
            <div class="timeline-step" data-step="4">
              <span class="step-number">4</span>
              <span class="step-label">Voice</span>
            </div>
            <div class="timeline-step" data-step="5">
              <span class="step-number">5</span>
              <span class="step-label">Publish</span>
            </div>
          </div>
          <div class="main-container">
            <div class="customize-section">
              <form id="customize-form">
                <!-- Step 1: Basics -->
                <div class="step" id="step-1">
                  <div class="form-group">
                    <label for="avatar-name">Avatar Name</label>
                    <input
                      type="text"
                      id="avatar-name"
                      placeholder="e.g., Zunair"
                      required
                    />
                  </div>
                </div>

                <!-- Step 2: Personality -->
                <div class="step" id="step-2" style="display: none">
                  <div class="form-group">
                    <label for="avatar-personality">Personality</label>
                    <div class="personality-tags">
                      <button type="button" class="tag" data-value="Patient">
                        Patient
                      </button>
                      <button type="button" class="tag" data-value="Humorous">
                        Humorous
                      </button>
                      <button
                        type="button"
                        class="tag"
                        data-value="Knowledgeable"
                      >
                        Knowledgeable
                      </button>
                      <button type="button" class="tag" data-value="Friendly">
                        Friendly
                      </button>
                      <button
                        type="button"
                        class="tag"
                        data-value="Professional"
                      >
                        Professional
                      </button>
                      <button
                        type="button"
                        class="tag"
                        data-value="Encouraging"
                      >
                        Encouraging
                      </button>
                    </div>
                    <textarea
                      id="avatar-personality"
                      placeholder="e.g., Patient, humorous, knowledgeable"
                      required
                    ></textarea>
                  </div>
                  <div class="form-group">
                    <label for="avatar-prompt">Prompt</label>
                    <textarea
                      id="avatar-prompt"
                      placeholder="e.g., Act as a doctor"
                      required
                    ></textarea>
                  </div>
                </div>

                <!-- Step 3: Knowledge -->
                <div class="step" id="step-3" style="display: none">
                  <div class="form-group">
                    <label>Select Knowledge Context</label>
                    <div class="knowledge-options">
                      <div class="knowledge-card" data-value="technology">
                        <span class="icon">üíª</span>
                        <strong>Technology</strong>
                        <p>Programming, AI, gadgets, and tech trends</p>
                      </div>
                      <div class="knowledge-card" data-value="medical">
                        <span class="icon">ü©∫</span>
                        <strong>Medical</strong>
                        <p>Health information and medical knowledge</p>
                      </div>
                      <div class="knowledge-card" data-value="general">
                        <span class="icon">üåê</span>
                        <strong>General Knowledge</strong>
                        <p>Broad knowledge across many domains</p>
                      </div>
                      <div class="knowledge-card" data-value="legal">
                        <span class="icon">‚öñÔ∏è</span>
                        <strong>Legal</strong>
                        <p>Laws, regulations, and legal concepts</p>
                      </div>
                      <div class="knowledge-card" data-value="creative">
                        <span class="icon">‚úçÔ∏è</span>
                        <strong>Creative</strong>
                        <p>Storytelling and creative content</p>
                      </div>
                      <div class="knowledge-card" data-value="education">
                        <span class="icon">üéì</span>
                        <strong>Education</strong>
                        <p>Teaching and educational content</p>
                      </div>
                      <div class="knowledge-card" data-value="finance">
                        <span class="icon">üí∞</span>
                        <strong>Finance</strong>
                        <p>Money, investing, and financial advice</p>
                      </div>
                      <div class="knowledge-card" data-value="document">
                        <span class="icon">üìÑ</span>
                        <strong>Document-Based</strong>
                        <p>Upload your own documents</p>
                      </div>
                    </div>
                    <input type="hidden" id="avatar-knowledge" required />
                  </div>
                  <div
                    class="form-group"
                    id="document-upload-group"
                    style="display: none"
                  >
                    <label for="document-upload"
                      >Upload Document (PDF, TXT)</label
                    >
                    <div class="document-upload-area" id="doc-drop-area">
                      <p><i class="fa-solid fa-cloud-arrow-up"></i></p>
                      <p>Drag & drop your document here or click to browse</p>
                      <p class="file-info">PDF or TXT, max 5MB</p>
                      <input
                        type="file"
                        id="document-upload"
                        accept=".pdf,.txt"
                        style="display: none"
                      />
                    </div>
                    <div id="document-preview" class="file-preview">
                      <div class="file-preview-info">
                        <i class="fa-solid fa-file-pdf document-icon"></i>
                        <span id="document-name">No file selected</span>
                      </div>
                      <button
                        type="button"
                        id="remove-document"
                        class="remove-file"
                      >
                        <i class="fa-solid fa-xmark"></i>
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Step 4: Voice -->
                <div class="step" id="step-4" style="display: none">
                  <div class="form-group">
                    <label for="avatar-voice">Select Voice</label>
                    <div style="display: flex; align-items: center; gap: 10px">
                      <select id="avatar-voice" required>
                        <option value="">Select a voice</option>
                        <!-- Populated dynamically -->
                      </select>
                      <button type="button" id="preview-voice-button">
                        <i class="fa-solid fa-play"></i> Preview
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Step 5: Publish to Marketplace -->
                <div class="step" id="step-5" style="display: none">
                  <div class="form-group" id="publish-section">
                    <div class="publish-container">
                      <h3>Ready to Share Your Alter?</h3>
                      <p>Make your alter available to others in the marketplace.</p>
                      <div class="form-group">
                        <label for="alter-description">Description</label>
                        <textarea id="alter-description" placeholder="Describe what makes your alter special..." required></textarea>
                      </div>
                      <div class="form-group">
                        <label for="alter-category">Category</label>
                        <select id="alter-category" required>
                          <option value="">Select a category</option>
                          <option value="professional">Professional</option>
                          <option value="gaming">Gaming</option>
                          <option value="entertainment">Entertainment</option>
                          <option value="service">Service</option>
                          <option value="education">Education</option>
                          <option value="other">Other</option>
                        </select>
                      </div>
                      <div class="form-group">
                        <label for="creator-name">Creator Name</label>
                        <input type="text" id="creator-name" placeholder="Your name or username" required />
                      </div>
                      <button type="button" id="publish-button" class="action-button primary">
                        <i class="fa-solid fa-upload"></i> Publish to Marketplace
                      </button>
                    </div>
                  </div>
                </div>

                <div class="form-actions">
                  <button type="button" id="prev-step" class="action-button">
                    Back
                  </button>
                  <button type="button" id="next-step" class="action-button">
                    Continue
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Floating particles background -->
    <div id="particles-container" class="particles-container"></div>

    <script type="module">
      import { publishAlter } from './marketplace-integration.js';
      
      document.addEventListener("DOMContentLoaded", async () => {
        console.log("customize.html: Script loaded");
        const form = document.getElementById("customize-form");
        const prevButton = document.getElementById("prev-step");
        const nextButton = document.getElementById("next-step");
        const backButton = document.getElementById("back-button");
        const nextNavButton = document.getElementById("next-button");
        const voiceSelect = document.getElementById("avatar-voice");
        const previewVoiceButton = document.getElementById(
          "preview-voice-button"
        );
        const knowledgeCards = document.querySelectorAll(".knowledge-card");
        const knowledgeInput = document.getElementById("avatar-knowledge");
        const documentUploadGroup = document.getElementById(
          "document-upload-group"
        );
        const documentUpload = document.getElementById("document-upload");
        const personalityTags = document.querySelectorAll(
          ".personality-tags .tag"
        );
        const personalityTextarea =
          document.getElementById("avatar-personality");
        const nameInput = document.getElementById("avatar-name");
        const docDropArea = document.getElementById("doc-drop-area");
        const documentPreview = document.getElementById("document-preview");
        const documentName = document.getElementById("document-name");
        const removeDocument = document.getElementById("remove-document");
        const publishButton = document.getElementById("publish-button");
        const alterDescriptionInput = document.getElementById("alter-description");
        const alterCategoryInput = document.getElementById("alter-category");
        const creatorNameInput = document.getElementById("creator-name");

        let currentStep = 1;
        const totalSteps = 5;

        // Load saved settings if they exist
        const savedSettings = JSON.parse(
          localStorage.getItem("avatarSettings") || "{}"
        );
        if (savedSettings.name) {
          nameInput.value = savedSettings.name;
        }
        document.getElementById("avatar-personality").value =
          savedSettings.personality || "";
        document.getElementById("avatar-prompt").value =
          savedSettings.prompt || "";
        knowledgeInput.value = savedSettings.knowledge || "";
        const savedVoiceId = savedSettings.voiceId || "";
        const savedDocumentUrl = savedSettings.documentUrl || "";

        // Highlight selected knowledge card
        if (knowledgeInput.value) {
          knowledgeCards.forEach((card) => {
            if (card.getAttribute("data-value") === knowledgeInput.value) {
              card.classList.add("selected");
            }
          });
        }

        // Initialize document upload area
        documentPreview.style.display = "none";

        // Document drop area event listeners
        docDropArea.addEventListener("click", () => {
          documentUpload.click();
        });

        docDropArea.addEventListener("dragover", (e) => {
          e.preventDefault();
          docDropArea.classList.add("drag-over");
        });

        docDropArea.addEventListener("dragleave", () => {
          docDropArea.classList.remove("drag-over");
        });

        docDropArea.addEventListener("drop", (e) => {
          e.preventDefault();
          docDropArea.classList.remove("drag-over");
          if (e.dataTransfer.files.length) {
            handleDocumentSelection(e.dataTransfer.files[0]);
          }
        });

        documentUpload.addEventListener("change", (e) => {
          if (e.target.files.length) {
            handleDocumentSelection(e.target.files[0]);
          }
        });

        removeDocument.addEventListener("click", () => {
          documentUpload.value = "";
          documentPreview.style.display = "none";
          docDropArea.style.display = "block";
          documentName.textContent = "No file selected";
        });

        function handleDocumentSelection(file) {
          const fileError = validateFile(file);
          if (fileError) {
            showError(fileError, documentUpload);
            return;
          }

          documentName.textContent = file.name;
          documentPreview.style.display = "flex";
          docDropArea.style.display = "none";

          // Update icon based on file type
          const documentIcon = documentPreview.querySelector(".document-icon");
          if (file.type === "application/pdf") {
            documentIcon.className = "fa-solid fa-file-pdf document-icon";
          } else {
            documentIcon.className = "fa-solid fa-file-lines document-icon";
          }
        }

        // Display error messages inline
        function showError(message, element = null) {
          const errorDiv = document.createElement("div");
          errorDiv.className = "error-message";
          errorDiv.style.color = "red";
          errorDiv.style.marginTop = "10px";
          errorDiv.textContent = message;
          if (element) {
            element.parentElement.appendChild(errorDiv);
          } else {
            form.appendChild(errorDiv);
          }
          setTimeout(() => errorDiv.remove(), 5000);
        }

        // Clear previous error messages
        function clearErrors() {
          document
            .querySelectorAll(".error-message")
            .forEach((el) => el.remove());
        }

        // Validate file before upload
        function validateFile(file) {
          const maxSize = 5 * 1024 * 1024; // 5MB
          const allowedTypes = ["application/pdf", "text/plain"];
          if (!file) return "No file selected.";
          if (file.size > maxSize) return "File size exceeds 5MB limit.";
          if (!allowedTypes.includes(file.type))
            return "Only PDF and TXT files are allowed.";
          return null;
        }

        // Toggle document upload field visibility
        function toggleDocumentUpload() {
          documentUploadGroup.style.display =
            knowledgeInput.value === "document" ? "block" : "none";
          if (knowledgeInput.value !== "document") {
            documentUpload.value = ""; // Clear file input
            documentPreview.style.display = "none";
            docDropArea.style.display = "block";
          }
        }

        // Handle knowledge card selection
        knowledgeCards.forEach((card) => {
          card.addEventListener("click", () => {
            knowledgeCards.forEach((c) => c.classList.remove("selected"));
            card.classList.add("selected");
            knowledgeInput.value = card.getAttribute("data-value");
            toggleDocumentUpload();
            clearErrors();
          });
        });

        toggleDocumentUpload(); // Initial check

        // Handle personality tag selection
        personalityTags.forEach((tag) => {
          tag.addEventListener("click", () => {
            tag.classList.toggle("selected");
            const selectedTags = Array.from(personalityTags)
              .filter((t) => t.classList.contains("selected"))
              .map((t) => t.getAttribute("data-value"))
              .join(", ");
            personalityTextarea.value = selectedTags;
          });
        });

        // Update timeline and step visibility
        function updateStep(step) {
          currentStep = step;
          document.querySelectorAll(".timeline-step").forEach((s) => {
            s.classList.remove("active");
            if (parseInt(s.getAttribute("data-step")) === currentStep) {
              s.classList.add("active");
            }
          });
          document.querySelectorAll(".step").forEach((s) => {
            s.style.display = s.id === `step-${currentStep}` ? "block" : "none";
          });
          prevButton.style.display = currentStep === 1 ? "none" : "block"; // Hide Back on first step
          nextButton.textContent =
            currentStep === totalSteps ? "Skip & Start Chat" : "Continue";
          clearErrors();
        }

        // Fetch Eleven Labs voices with retry
        async function loadVoices(attempt = 1, maxAttempts = 3) {
          try {
            console.log(`customize.html: Attempt ${attempt} to load voices`);
            const response = await fetch("/api-config");
            if (!response.ok) {
              throw new Error("Failed to fetch API configuration");
            }
            const config = await response.json();
            const apiKey = config.elevenlabs_key;
            if (!apiKey) {
              throw new Error("Missing Eleven Labs API key in configuration");
            }

            const voicesResponse = await fetch(
              "https://api.elevenlabs.io/v1/voices",
              {
                headers: {
                  "xi-api-key": apiKey,
                  Accept: "application/json",
                },
              }
            );
            if (!voicesResponse.ok) {
              const errorData = await voicesResponse.json().catch(() => ({}));
              throw new Error(
                `Failed to fetch voices: ${
                  errorData.message || voicesResponse.statusText
                }`
              );
            }
            const { voices } = await voicesResponse.json();

            voiceSelect.innerHTML = '<option value="">Select a voice</option>';
            voices.forEach((voice) => {
              const option = document.createElement("option");
              option.value = voice.voice_id;
              option.textContent = voice.name || voice.voice_id;
              if (voice.voice_id === savedVoiceId) {
                option.selected = true;
              }
              voiceSelect.appendChild(option);
            });

            console.log("customize.html: Voices loaded successfully", voices);
          } catch (error) {
            console.error(
              `customize.html: Error loading voices (attempt ${attempt}):`,
              error
            );
            if (attempt < maxAttempts) {
              console.log(
                `customize.html: Retrying... (${attempt + 1}/${maxAttempts})`
              );
              return loadVoices(attempt + 1, maxAttempts);
            }
            voiceSelect.innerHTML =
              '<option value="">Failed to load voices</option>';
            showError(
              `Failed to load voices after ${maxAttempts} attempts: ${error.message}. Please check your Eleven Labs API key or network connection.`,
              voiceSelect
            );
          }
        }

        // Preview voice functionality
        async function previewVoice() {
          const voiceId = voiceSelect.value;
          if (!voiceId) {
            showError("Please select a voice to preview.", voiceSelect);
            return;
          }

          previewVoiceButton.disabled = true;
          previewVoiceButton.innerHTML =
            '<i class="fa-solid fa-spinner fa-spin"></i> Playing...';

          try {
            const response = await fetch("/api-config");
            if (!response.ok) {
              throw new Error("Failed to fetch API configuration");
            }
            const config = await response.json();
            const apiKey = config.elevenlabs_key;
            if (!apiKey) {
              throw new Error("Missing Eleven Labs API key in configuration");
            }

            const sampleText = "Hello, this is a voice preview.";
            const audioResponse = await fetch(
              `https://api.elevenlabs.io/v1/text-to-speech/${voiceId}`,
              {
                method: "POST",
                headers: {
                  "xi-api-key": apiKey,
                  "Content-Type": "application/json",
                  Accept: "audio/mpeg",
                },
                body: JSON.stringify({
                  text: sampleText,
                  model_id: "eleven_monolingual_v1",
                  voice_settings: {
                    stability: 0.5,
                    similarity_boost: 0.5,
                  },
                }),
              }
            );

            if (!audioResponse.ok) {
              const errorData = await audioResponse.json().catch(() => ({}));
              throw new Error(
                `Failed to generate preview: ${
                  errorData.detail?.message || audioResponse.statusText
                }`
              );
            }

            const audioBlob = await audioResponse.blob();
            const audioUrl = URL.createObjectURL(audioBlob);
            const audio = new Audio(audioUrl);
            audio.play();

            audio.onended = () => {
              previewVoiceButton.disabled = false;
              previewVoiceButton.innerHTML =
                '<i class="fa-solid fa-play"></i> Preview';
              URL.revokeObjectURL(audioUrl);
            };
          } catch (error) {
            console.error("customize.html: Error previewing voice:", error);
            showError(`Failed to preview voice: ${error.message}`, voiceSelect);
            previewVoiceButton.disabled = false;
            previewVoiceButton.innerHTML =
              '<i class="fa-solid fa-play"></i> Preview';
          }
        }

        // Load voices on page load
        await loadVoices();

        // Handle preview voice button click
        previewVoiceButton.addEventListener("click", previewVoice);

        // Handle navigation
        prevButton.addEventListener("click", () => {
          if (currentStep > 1) {
            updateStep(currentStep - 1);
          }
        });

        backButton.addEventListener("click", () => {
          if (currentStep > 1) {
            updateStep(currentStep - 1);
          }
        });

        nextButton.addEventListener("click", async () => {
          clearErrors();
          if (currentStep < totalSteps) {
            // Validate current step
            let isValid = true;
            if (currentStep === 1) {
              const name = nameInput.value.trim();
              if (!name) {
                showError("Please enter an avatar name.", nameInput);
                isValid = false;
              }
            } else if (currentStep === 2) {
              const personality = document
                .getElementById("avatar-personality")
                .value.trim();
              const prompt = document
                .getElementById("avatar-prompt")
                .value.trim();
              if (!personality) {
                showError(
                  "Please select or enter a personality.",
                  document.getElementById("avatar-personality")
                );
                isValid = false;
              }
              if (!prompt) {
                showError(
                  "Please enter a prompt.",
                  document.getElementById("avatar-prompt")
                );
                isValid = false;
              }
            } else if (currentStep === 3) {
              if (!knowledgeInput.value) {
                showError(
                  "Please select a knowledge context.",
                  document.querySelector(".knowledge-options")
                );
                isValid = false;
              }
              if (
                knowledgeInput.value === "document" &&
                documentUpload.files.length === 0
              ) {
                showError("Please upload a document.", documentUpload);
                isValid = false;
              }
              if (
                knowledgeInput.value === "document" &&
                documentUpload.files.length > 0
              ) {
                const file = documentUpload.files[0];
                const fileError = validateFile(file);
                if (fileError) {
                  showError(fileError, documentUpload);
                  isValid = false;
                }
              }
            } else if (currentStep === 4) {
              const voiceId = voiceSelect.value;
              if (!voiceId) {
                showError("Please select a voice.", voiceSelect);
                isValid = false;
              }
            }

            if (isValid) {
              updateStep(currentStep + 1);
            }
          } else {
            // Final step: save and redirect
            const name = nameInput.value.trim();
            const personality = document
              .getElementById("avatar-personality")
              .value.trim();
            const prompt = document
              .getElementById("avatar-prompt")
              .value.trim();
            const knowledge = knowledgeInput.value;
            const voiceId = voiceSelect.value;
            let documentUrl = "";
            let documentName = "";
            let documentContent = "";

            // Handle document upload to server
            if (knowledge === "document" && documentUpload.files.length > 0) {
              const file = documentUpload.files[0];
              const fileError = validateFile(file);
              if (fileError) {
                showError(fileError, documentUpload);
                return;
              }

              try {
                const formData = new FormData();
                formData.append("document", file);
                const response = await fetch("/upload-document", {
                  method: "POST",
                  body: formData,
                });

                if (!response.ok) {
                  let errorData;
                  try {
                    errorData = await response.json();
                  } catch {
                    errorData = { error: response.statusText };
                  }
                  throw new Error(
                    `Failed to upload document: ${
                      errorData.error || response.statusText
                    }`
                  );
                }

                const result = await response.json();
                if (!result.documentUrl || !result.documentContent) {
                  throw new Error(
                    "Server response missing documentUrl or documentContent"
                  );
                }
                documentUrl = result.documentUrl;
                documentName = result.documentName;
                documentContent = result.documentContent;
              } catch (error) {
                console.error(
                  "customize.html: Error uploading document:",
                  error
                );
                showError(
                  `Failed to upload document: ${error.message}`,
                  documentUpload
                );
                return;
              }
            }

            if (name && personality && prompt && knowledge && voiceId) {
              localStorage.setItem(
                "avatarSettings",
                JSON.stringify({
                  name,
                  personality,
                  prompt,
                  knowledge,
                  voiceId,
                  documentName,
                  documentUrl,
                  documentContent,
                  avatarUrl: savedSettings.avatarUrl || '',
                })
              );
              console.log(
                "customize.html: Settings saved, redirecting to /chat"
              );
              window.location.href = "/chat";
            } else {
              showError(
                "Please complete all fields, including selecting a voice.",
                form
              );
              console.log("customize.html: Validation failed");
            }
          }
        });

        nextNavButton.addEventListener("click", () => {
          nextButton.click();
        });

        // Handle publish button click
        publishButton.addEventListener("click", async () => {
          const name = nameInput.value.trim();
          const description = alterDescriptionInput.value.trim();
          const category = alterCategoryInput.value.trim();
          const creatorName = creatorNameInput.value.trim();
          const personality = document.getElementById("avatar-personality").value.trim();
          const prompt = document.getElementById("avatar-prompt").value.trim();
          const knowledge = knowledgeInput.value;
          const voiceId = voiceSelect.value;
          
          // Validate inputs
          if (!name || !description || !category || !creatorName || !personality || !prompt || !knowledge || !voiceId) {
            showError("Please fill in all required fields");
            return;
          }
          
          // Show loading state
          publishButton.disabled = true;
          publishButton.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Publishing...';
          
          // Prepare alter data
          const alterData = {
            name,
            description,
            category,
            creatorName,
            avatarUrl: savedSettings.avatarUrl || '',
            personality,
            prompt,
            knowledge,
            voiceId
          };
          
          // Publish alter
          const result = await publishAlter(alterData);
          
          // Reset button state
          publishButton.disabled = false;
          publishButton.innerHTML = '<i class="fa-solid fa-upload"></i> Publish to Marketplace';
          
          // Handle result
          if (result.success) {
            alert('Your alter has been published to the marketplace!');
            // Redirect to marketplace
            window.location.href = '/marketplace';
          } else {
            showError(`Failed to publish alter: ${result.error}`);
          }
        });

        // Initialize first step
        updateStep(1);

        // Create particles for background effect
        createParticles();
      });

      // Create floating particles
      function createParticles() {
        const particlesContainer = document.getElementById(
          "particles-container"
        );
        const particleCount = 30;

        for (let i = 0; i < particleCount; i++) {
          const particle = document.createElement("div");
          particle.classList.add("particle");

          // Random size between 2px and 6px
          const size = Math.random() * 4 + 2;
          particle.style.width = `${size}px`;
          particle.style.height = `${size}px`;

          // Random position
          particle.style.left = `${Math.random() * 100}%`;
          particle.style.top = `${Math.random() * 100}%`;

          // Random opacity
          particle.style.opacity = Math.random() * 0.5 + 0.1;

          // Animation duration and delay
          const duration = Math.random() * 20 + 10;
          const delay = Math.random() * 5;
          particle.style.animation = `float ${duration}s ease-in-out ${delay}s infinite`;

          particlesContainer.appendChild(particle);
        }
      }
    </script>
  </body>
</html>
